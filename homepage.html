<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dollarsurvey | Home</title>

  <style>
    :root{
      --bg:#000;
      --accent:#adff2f;
      --accent-dark:#7bbf1a;
      --card-bg: rgba(13,13,13,0.8);
      --glass: rgba(173,255,47,0.04);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--accent);font-family:Inter, "Segoe UI",system-ui, -apple-system, "Helvetica Neue", Arial; -webkit-font-smoothing:antialiased;}
    .wrap{max-width:980px;margin:32px auto;padding:18px;box-sizing:border-box;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .left{display:flex;align-items:center;gap:12px;}
    a.logo{display:inline-flex;align-items:center;gap:10px;text-decoration:none;color:var(--accent);}
    .logo-box{width:56px;height:56px;border-radius:8px;background:linear-gradient(180deg, rgba(173,255,47,0.08), rgba(173,255,47,0.02));display:flex;align-items:center;justify-content:center;font-weight:700;border:1px solid rgba(173,255,47,0.14);}
    .small-info{display:flex;gap:8px;align-items:center;}
    .info-pill{background:var(--glass);border:1px solid rgba(173,255,47,0.12);padding:6px 10px;border-radius:10px;font-size:13px;min-width:86px;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,0.6);}
    .info-label{display:block;font-size:11px;color:#bff789;opacity:0.9;margin-bottom:3px;}
    .menu-btn{background:var(--accent);border:none;color:#000;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer;}
    /* Modal menu */
    .menu-modal{position:fixed;top:12px;right:12px;background:linear-gradient(180deg, rgba(173,255,47,0.98), var(--accent));color:#000;border-radius:12px;padding:14px;box-shadow:0 10px 40px rgba(0,0,0,0.6);display:none;z-index:80;}
    .menu-modal a{display:block;color:#000;text-decoration:none;padding:8px 0;font-weight:600;}
    /* Heading */
    .title{margin:28px 0 14px;font-size:28px;font-weight:800;line-height:1.05;color:var(--accent);text-shadow:0 2px 12px rgba(173,255,47,0.06);}
    /* Surveys grid */
    .surveys{display:grid;grid-template-columns:1fr;gap:14px;}
    .card{background:var(--card-bg);padding:14px;border-radius:12px;border:1px solid rgba(173,255,47,0.06);box-shadow:0 6px 30px rgba(0,0,0,0.6);}
    .qtitle{font-weight:800;color:var(--accent);margin-bottom:8px;}
    .qtext{font-size:14px;color:#cfffa0;margin-bottom:10px;line-height:1.35;}
    textarea{width:100%;min-height:64px;padding:10px;font-size:15px;border-radius:8px;border:1px solid rgba(173,255,47,0.12);background:transparent;color:var(--accent);resize:vertical;outline:none;}
    .card-row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:10px;}
    .share-btn{background:transparent;border:none;color:var(--accent);cursor:pointer;font-size:18px;padding:8px;border-radius:8px;display:flex;align-items:center;gap:8px;}
    .submit-row{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:14px;}
    .submit-btn{background:var(--accent);border:none;padding:12px 18px;border-radius:10px;font-weight:800;color:#000;cursor:pointer;}
    .submit-btn[disabled]{opacity:0.6;cursor:not-allowed;}
    #notify{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:rgba(0,0,0,0.8);color:var(--accent);border:1px solid rgba(173,255,47,0.12);padding:12px 16px;border-radius:10px;font-weight:700;box-shadow:0 8px 40px rgba(0,0,0,0.7);display:none;z-index:90;}
    .mini{font-size:12px;color:#dfffa8;}
    /* responsive grid */
    @media(min-width:720px){
      .surveys{grid-template-columns:1fr 1fr;gap:16px;}
      .title{font-size:32px;}
    }
    @media(max-width:420px){
      .logo-box{width:46px;height:46px;}
      .info-pill{min-width:72px;padding:6px 8px;font-size:12px;border-radius:8px;}
      .title{font-size:22px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="left">
        <a class="logo" href="#">
          <div class="logo-box">DS</div>
        </a>

        <div class="small-info">
          <div class="info-pill" id="userIdWrap">
            <span class="info-label">User ID</span>
            <span id="userId">guest-xxxxx</span>
          </div>
          <div class="info-pill" id="balanceWrap">
            <span class="info-label">Balance</span>
            <span id="balance">$0.00</span>
          </div>
        </div>
      </div>

      <div>
        <button id="menuToggle" class="menu-btn">MENU</button>
        <div id="menuModal" class="menu-modal" aria-hidden="true">
          <a href="#">Home</a>
          <a href="login.html">Login</a>
          <a href="register.html">Register</a>
          <a href="#">Terms & Privacy</a>
        </div>
      </div>
    </header>

    <main>
      <h1 class="title">We have got some surveys for you</h1>

      <section class="surveys" id="surveysContainer">
        <!-- JS injects 10 questions here -->
      </section>

      <div class="submit-row">
        <div class="mini" id="statusHint">All answers required (min 5 char each)</div>
        <button id="submitBtn" class="submit-btn">Submit all</button>
      </div>
    </main>
  </div>

  <div id="notify"></div>

  <!-- Firebase -->
  <script type="module">
    // Firebase imports (v10)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getDatabase, ref, push, set, update, get, child } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    // Provided config
    const firebaseConfig = {
      apiKey: "AIzaSyDnq2364tMuRPbrjjHmUfFUTjWZC2BmIS4",
      authDomain: "dollar-survey-60fe7.firebaseapp.com",
      projectId: "dollar-survey-60fe7",
      storageBucket: "dollar-survey-60fe7.firebasestorage.app",
      messagingSenderId: "293471697208",
      appId: "1:293471697208:web:664863f09e830e420c69cd",
      measurementId: "G-RCZ7SQJHPZ"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e){/* analytics may fail in some contexts */ }
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Questions array (10 questions ~50 words each, product preference + situation)
    const questions = [
      {
        title: "Comfortable daily headphones",
        text: "You often commute for 45 minutes each way and want headphones that are comfortable for long wear, block noise, and last a full day of listening. Which features and price range would you prefer when buying a new pair?"
      },
      {
        title: "Home coffee solution",
        text: "You want a coffee maker that fits a small kitchen and makes single-serve specialty drinks faster than a cafe. Would you choose a pod, espresso machine, or manual brewer? Mention ease-of-use and cost concerns."
      },
      {
        title: "Smartwatch for health tracking",
        text: "You’d like a wrist device to track workouts, sleep, and heart rate, and also show messages. How important are battery life, style, and third-party app support when choosing a smartwatch?"
      },
      {
        title: "Portable power bank",
        text: "On trips, you need a compact power bank able to charge phone and earbuds twice. Would you trade size for higher capacity or prioritize portability? Mention charger type and cost expectations."
      },
      {
        title: "Eco-friendly cleaning supplies",
        text: "You plan to switch cleaning products to greener alternatives. How much extra would you pay for biodegradable ingredients and recyclable packaging versus standard cleaners when shopping weekly?"
      },
      {
        title: "Subscription streaming choices",
        text: "You like movies and some niche documentaries. Would you pay for a smaller, specialized streaming service or stick with a large all-in-one platform? Explain preferences on price and content exclusivity."
      },
      {
        title: "Ergonomic home office chair",
        text: "You work from home and sit many hours. Would you invest in a pricey ergonomic chair that promises posture benefits or seek an affordable chair with lumbar support? Mention expected lifespan and comfort priorities."
      },
      {
        title: "Meal kit delivery for busy nights",
        text: "On weekdays you have limited time but value home-cooked meals. Would you subscribe to meal kits that save prep time even if more expensive? Describe convenience vs cost trade-offs."
      },
      {
        title: "Compact camera for travel",
        text: "When traveling, you want a camera that beats phone quality but fits in a backpack. Would you choose mirrorless, compact point-and-shoot, or high-end phone upgrades? Mention weight, lens options, and budget."
      },
      {
        title: "Noise-reducing window solutions",
        text: "Living near a busy road, you are considering window upgrades to reduce noise. Would you choose triple-pane windows, secondary glazing, or specialized curtains? Mention installation disruption and relative costs."
      }
    ];

    // Elements
    const surveysContainer = document.getElementById('surveysContainer');
    const submitBtn = document.getElementById('submitBtn');
    const notifyEl = document.getElementById('notify');
    const userIdSpan = document.getElementById('userId');
    const balanceSpan = document.getElementById('balance');
    const menuBtn = document.getElementById('menuToggle');
    const menuModal = document.getElementById('menuModal');

    // Utilities
    function showNotify(msg, duration = 3000){
      notifyEl.innerText = msg;
      notifyEl.style.display = 'block';
      setTimeout(()=> notifyEl.style.display = 'none', duration);
    }

    // Create survey cards
    function renderSurveys(){
      surveysContainer.innerHTML = '';
      questions.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="qtitle">${escapeHtml(q.title)}</div>
          <div class="qtext">${escapeHtml(q.text)}</div>
          <textarea placeholder="Write your answer (min 5 chars)" data-qi="${idx}" minlength="5"></textarea>
          <div class="card-row">
            <div class="mini">Min 5 characters</div>
            <div>
              <button class="share-btn" data-qi="${idx}" title="Share">↗ Share</button>
            </div>
          </div>
        `;
        surveysContainer.appendChild(card);
      });

      // Attach share handlers
      document.querySelectorAll('.share-btn').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const url = window.location.href.split('#')[0];
          try{
            if(navigator.share){
              await navigator.share({title:'Dollarsurvey', text:'Check out this survey', url});
              showNotify('Shared successfully');
            } else {
              await navigator.clipboard.writeText(url);
              showNotify('Link copied to clipboard');
            }
          } catch(err){
            console.warn(err);
            showNotify('Unable to share',2000);
          }
        });
      });
    }

    // Basic XSS escape for texts we insert
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

    // Generate stable guest id (stored in localStorage)
    function getGuestId(){
      let gid = localStorage.getItem('ds_guest_id');
      if(!gid){
        gid = 'guest-' + Math.random().toString(36).slice(2,8);
        localStorage.setItem('ds_guest_id', gid);
      }
      return gid;
    }

    // Balance logic
    let balance = 0.00;
    let currentUser = null; // firebase user or null
    let currentUserId = getGuestId(); // displayed id (guest or first5 of email)
    function setBalanceUI(){
      balanceSpan.innerText = `$${Number(balance).toFixed(2)}`;
    }

    // Attempt to load balance from firebase or localStorage
    async function loadBalance() {
      // priority: firebase user balance -> localStorage -> default 0
      if(currentUser && currentUser.uid){
        try {
          const snap = await get(ref(db, `users/${currentUser.uid}/balance`));
          if (snap && snap.exists && !isNaN(snap.val())) {
            balance = Number(snap.val());
            localStorage.setItem('ds_balance', balance.toFixed(2));
          } else {
            // if no balance on server but local storage exists, sync server with local
            const localBal = parseFloat(localStorage.getItem('ds_balance') || '0');
            if(localBal>0){
              balance = localBal;
              await set(ref(db, `users/${currentUser.uid}/balance`), balance);
            } else {
              balance = 0;
            }
          }
        } catch(e){
          console.warn('Could not load balance from firebase', e);
          balance = parseFloat(localStorage.getItem('ds_balance') || '0');
        }
      } else {
        // guest
        balance = parseFloat(localStorage.getItem('ds_balance') || '0');
      }
      setBalanceUI();
    }

    // Increase balance by $0.5 (UI + firebase attempt)
    async function addBalanceIncrement(){
      const increment = 0.5;
      balance = Number((Number(balance) + increment).toFixed(2));
      setBalanceUI();
      localStorage.setItem('ds_balance', balance.toFixed(2));

      // try updating firebase; succeed or fail, UI already updated (per requirement)
      if(currentUser && currentUser.uid){
        try {
          await set(ref(db, `users/${currentUser.uid}/balance`), balance);
        } catch(e){
          console.warn('Failed to write balance to firebase for user', e);
          // optionally push a pending update to localStorage
          let pend = JSON.parse(localStorage.getItem('ds_pending') || '[]');
          pend.push({type:'balance', uid: currentUser.uid, balance, ts:Date.now()});
          localStorage.setItem('ds_pending', JSON.stringify(pend));
        }
      } else {
        // guest store under guests/<guestId>/balance
        try {
          const guestId = currentUserId;
          await set(ref(db, `guests/${guestId}/balance`), balance);
        } catch(e){
          console.warn('Failed to write guest balance to firebase', e);
          let pend = JSON.parse(localStorage.getItem('ds_pending') || '[]');
          pend.push({type:'guest-balance', guestId: currentUserId, balance, ts:Date.now()});
          localStorage.setItem('ds_pending', JSON.stringify(pend));
        }
      }
    }

    // Submit handler
    submitBtn.addEventListener('click', async ()=>{
      const textareas = Array.from(document.querySelectorAll('textarea'));
      // validate all >=5 chars (trim)
      for(const ta of textareas){
        if((ta.value||'').trim().length < 5){
          showNotify('All answers must be at least 5 characters', 3000);
          return;
        }
      }

      // Gather answers
      const payload = {
        userId: currentUser && currentUser.uid ? currentUser.uid : currentUserId,
        displayId: currentUser && currentUser.email ? (currentUser.email.slice(0,5)) : currentUserId,
        ts: Date.now(),
        answers: questions.map((q, i) => ({title: q.title, answer: (document.querySelector(`textarea[data-qi="${i}"]`).value||'').trim()}))
      };

      // disable submit and show feedback
      submitBtn.disabled = true;
      showNotify('Submitting answers...');

      // Wait 3 seconds and then treat as success (per requirement)
      await new Promise(r => setTimeout(r, 3000));

      // Update UI balance immediately
      await addBalanceIncrement();

      // Attempt to store submission to firebase, but treat success regardless
      try {
        if(currentUser && currentUser.uid){
          // push to users/<uid>/submissions
          await push(ref(db, `users/${currentUser.uid}/submissions`), payload);
        } else {
          // guests/<guestId>/submissions
          await push(ref(db, `guests/${currentUserId}/submissions`), payload);
        }
      } catch(e){
        console.warn('Failed to push submission to firebase', e);
        // save pending locally so developer might re-sync later
        let pend = JSON.parse(localStorage.getItem('ds_pending') || '[]');
        pend.push({type:'submission', payload, ts:Date.now()});
        localStorage.setItem('ds_pending', JSON.stringify(pend));
      }

      // success UX
      showNotify('Submission successful! +$0.50 added', 3500);

      // clear all answer bars
      document.querySelectorAll('textarea').forEach(ta => ta.value = '');

      // re-enable after short delay
      setTimeout(()=> submitBtn.disabled = false, 1000);
    });

    // Menu toggle
    menuBtn.addEventListener('click', ()=>{
      const open = menuModal.style.display === 'block';
      menuModal.style.display = open ? 'none' : 'block';
      menuModal.setAttribute('aria-hidden', open ? 'true' : 'false');
    });
    // close menu clicking outside
    document.addEventListener('click', (e)=>{
      if(!menuModal.contains(e.target) && !menuBtn.contains(e.target)) menuModal.style.display = 'none';
    });

    // On load render questions
    renderSurveys();

    // Auth state: update user id display and load balance
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if(user && user.email){
        const id = String(user.email).slice(0,5);
        currentUserId = id;
        userIdSpan.innerText = id;
        // attempt to create user record if not exists
        try {
          const snap = await get(ref(db, `users/${user.uid}`));
          if(!snap.exists()){
            await set(ref(db, `users/${user.uid}`), { email: user.email, createdAt: Date.now(), provider: 'email' });
          } else {
            // if email changed on server, update minimal info
            await update(ref(db, `users/${user.uid}`), { email: user.email });
          }
        } catch(e){
          console.warn('Could not ensure user record', e);
        }
      } else {
        // guest
        currentUserId = getGuestId();
        userIdSpan.innerText = currentUserId;
      }
      // load balance (firebase preferred)
      await loadBalance();
    });

    // Provide initial UI values right away
    userIdSpan.innerText = currentUserId;
    balanceSpan.innerText = `$${(parseFloat(localStorage.getItem('ds_balance')||'0')).toFixed(2)}`;

  </script>
</body>
</html>
