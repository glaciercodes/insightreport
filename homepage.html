<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dollarsurvey | Home</title>
  <style>
    :root{
      --green:#adff2f;
      --bg:#000;
      --panel: rgba(0,255,0,0.05);
      --glass: rgba(173,255,47,0.06);
      --muted: #9fbf5f;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--green);font-family:Inter, "Segoe UI", system-ui, -apple-system, sans-serif;-webkit-font-smoothing:antialiased}
    .wrap{max-width:980px;margin:28px auto;padding:18px;display:flex;flex-direction:column;gap:16px}
    /* header */
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:64px;height:64px;border-radius:10px;background:linear-gradient(180deg,#081,#020);display:flex;align-items:center;justify-content:center;text-decoration:none;color:#000;font-weight:700}
    .title{font-size:20px;font-weight:700}
    .sub{font-size:13px;color:var(--muted);margin-top:3px}
    /* top-right menu */
    .menu-btn{background:var(--green);color:#000;padding:8px 12px;border-radius:10px;font-weight:700;border:none;cursor:pointer}
    .menu-panel{position:fixed;top:16px;right:16px;background:var(--panel);border:1px solid var(--green);padding:12px;border-radius:8px;display:none;min-width:160px;box-shadow:0 8px 30px rgba(0,255,0,0.06)}
    .menu-panel a{display:block;color:var(--green);text-decoration:none;padding:8px 6px;border-radius:6px}
    .menu-panel a:hover{background:var(--glass)}
    /* user info row */
    .info{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--green);background:transparent;font-weight:600}
    .id-chip{letter-spacing:1px}
    .balance{font-weight:800;background:linear-gradient(90deg,rgba(173,255,47,0.06),transparent);padding:8px 12px;border-radius:10px;border:1px solid var(--green)}
    .signout{background:transparent;border:1px solid var(--green);padding:8px 10px;border-radius:8px;color:var(--green);cursor:pointer}
    /* surveys area */
    .surveys{background:rgba(0,0,0,0.35);padding:18px;border-radius:12px;border:1px solid rgba(173,255,47,0.06);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .surveys h1{font-size:24px;margin:0 0 14px 0;font-weight:900}
    .question{padding:14px;border-radius:10px;border:1px solid rgba(173,255,47,0.06);margin-bottom:12px;background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.55))}
    .q-text{font-size:15px;line-height:1.4;margin-bottom:8px;color:var(--green)}
    textarea{width:100%;min-height:64px;padding:10px;border-radius:8px;border:1px solid var(--green);background:transparent;color:var(--green);resize:vertical;outline:none;font-size:14px}
    .q-actions{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .share{background:transparent;border:1px solid var(--green);padding:6px 10px;border-radius:8px;cursor:pointer}
    .share:active{transform:translateY(1px)}
    /* submit */
    .submit-row{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:10px}
    .submit-btn{background:var(--green);border:none;padding:12px 18px;border-radius:12px;font-weight:800;color:#000;cursor:pointer}
    .submit-btn[disabled]{opacity:0.35;cursor:not-allowed}
    /* notification */
    #notify{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;padding:12px 18px;border-radius:10px;background:rgba(0,0,0,0.9);border:1px solid var(--green);color:var(--green);font-weight:700;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s}
    #notify.show{opacity:1;transform:translate(-50%,-6px);pointer-events:auto}
    /* responsive */
    @media (max-width:600px){
      .wrap{padding:12px}
      .logo{width:52px;height:52px}
      .title{font-size:18px}
      .surveys h1{font-size:20px}
      textarea{min-height:72px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <a class="logo" href="#" aria-label="Dollarsurvey logo">DS</a>
        <div>
          <div class="title">Welcome to Dollarsurvey</div>
          <div class="sub">Earn by sharing short opinions</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div class="menu-btn" id="menuBtn">Menu</div>
        <div class="menu-panel" id="menuPanel" role="menu" aria-hidden="true">
          <a href="#" id="gotoHome">Home</a>
          <a href="#" id="gotoProfile">Profile</a>
          <a href="#" id="gotoFAQ">FAQ</a>
          <a href="#" id="logoutBtn">Sign out</a>
        </div>
      </div>
    </header>

    <section class="info" aria-live="polite">
      <div class="chip id-chip">User ID: <span id="userId">â€”</span></div>
      <div class="balance">Balance: <span id="balanceVal">$0.00</span></div>
      <button class="signout" id="signOutSmall">Sign out</button>
    </section>

    <section class="surveys" id="surveysSection">
      <h1>We have got some surveys for you</h1>

      <form id="surveyForm">
        <!-- questions injected here -->
        <div id="questionsWrap"></div>

        <div class="submit-row">
          <div style="flex:1;color:var(--muted);font-size:13px;padding-left:6px">All fields required. Min 5 characters per answer.</div>
          <button class="submit-btn" id="submitBtn" type="submit" disabled>Submit & Earn +$0.50</button>
        </div>
      </form>
    </section>
  </div>

  <div id="notify" role="status"></div>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      runTransaction,
      get,
      child
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    // ---- your firebase config (kept from your snippet) ----
    const firebaseConfig = {
      apiKey: "AIzaSyDnq2364tMuRPbrjjHmUfFUTjWZC2BmIS4",
      authDomain: "dollar-survey-60fe7.firebaseapp.com",
      projectId: "dollar-survey-60fe7",
      storageBucket: "dollar-survey-60fe7.firebasestorage.app",
      messagingSenderId: "293471697208",
      appId: "1:293471697208:web:664863f09e830e420c69cd",
      measurementId: "G-RCZ7SQJHPZ"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e){ /* analytics may fail in some envs */ }
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ------ UI helpers ------
    const notifyEl = document.getElementById('notify');
    function notify(msg, ms = 3000){
      notifyEl.textContent = msg;
      notifyEl.classList.add('show');
      setTimeout(()=> notifyEl.classList.remove('show'), ms);
    }

    // menu toggle
    const menuBtn = document.getElementById('menuBtn');
    const menuPanel = document.getElementById('menuPanel');
    menuBtn.addEventListener('click', ()=> {
      const open = menuPanel.style.display === 'block';
      menuPanel.style.display = open ? 'none' : 'block';
      menuPanel.setAttribute('aria-hidden', open ? 'true' : 'false');
    });
    document.addEventListener('click', (e)=>{
      if (!menuPanel.contains(e.target) && e.target !== menuBtn) menuPanel.style.display = 'none';
    });

    // sign out handlers
    const logoutBtn = document.getElementById('logoutBtn');
    const signOutSmall = document.getElementById('signOutSmall');
    async function doSignOut(){
      try {
        await signOut(auth);
        notify('Signed out â€” redirecting to login', 1800);
        setTimeout(()=> location.href = 'login.html', 1200);
      } catch(e){ notify('Sign out failed', 2200); }
    }
    logoutBtn.addEventListener('click', doSignOut);
    signOutSmall.addEventListener('click', doSignOut);

    // ---- survey questions (Adsense-safe, ~50 words each) ----
    const SURVEYS = [
`When shopping for a new smartphone, think about the last time you replaced yours. Describe which three features mattered most (battery life, camera, price, brand support, durability) and why. Which of these would you pay a small premium for if it significantly improved daily use?`,
`Imagine buying a pair of everyday headphones. Describe what you expect in sound, fit, durability, and connectivity. Would you trade some sound fidelity for longer battery life or better build quality? Explain which attribute influences repeat purchases for you in typical daily listening situations.`,
`When choosing household cleaning products, describe the top concerns you have (scent, eco-friendliness, effectiveness, price, packaging). Tell us how you decide between a known brand and a cheaper store brand. Which label or claim makes you more likely to try a new product?`,
`Think about buying coffee or tea beverages on the go. Describe the factors that influence where you buy (taste, convenience, price, loyalty programs). How often do promotions or app rewards make you switch from your usual choice? Tell us how you pick a new beverage to try.`,
`When picking casual shoes for daily wear, describe the balance you look for among comfort, style, price, and durability. Would you pay more for sustainable materials or recognized brand names? Explain how often you replace shoes and what design choices make you keep a pair longer.`,
`Consider subscription services (entertainment, fitness, or meals). Describe what convinces you to subscribe or cancel (content, cost, flexibility, recommendations). Which features in an app or plan make you value the service most, and under what circumstances would you recommend it to friends?`,
`When buying kitchen appliances, describe which aspects matter most (energy efficiency, warranty, size, ease of cleaning). How do you research options and balance brand reputation with price? Explain a recent appliance purchase and what made you choose that model over others.`,
`Think about personal care items (skincare, shampoo, toothpaste). Describe how you assess new products: ingredient lists, reviews, brand trust, or price. Which type of claim (organic, dermatologist-tested, cruelty-free) most influences your decision to try or regularly buy a product?`,
`Imagine choosing a travel backpack or daypack. Describe what features you prioritize (size, comfort, weather resistance, pockets, laptop protection). How much does brand reputation influence your choice versus firsthand reviews or product features? Share one must-have pocket or function.`,
`When deciding where to buy groceries, describe the priorities that guide you (price, freshness, selection, convenience, online pickup). Would you be willing to pay extra for same-day delivery or specialty items? Describe one recent grocery decision and what influenced it the most.`
    ];

    // ensure each survey is roughly ~50 words; these were written to be ~45-60 words and remain Adsense-safe.

    // create question blocks
    const qWrap = document.getElementById('questionsWrap');
    function renderQuestions(){
      qWrap.innerHTML = '';
      SURVEYS.forEach((txt, i) => {
        const q = document.createElement('div');
        q.className = 'question';
        q.innerHTML = `
          <div class="q-text"><strong>Q${i+1}.</strong> ${escapeHtml(txt)}</div>
          <textarea name="q${i}" id="q${i}" placeholder="Write your answer (min 5 chars)"></textarea>
          <div class="q-actions">
            <div style="font-size:12px;color:var(--muted)">Answer must be at least 5 characters</div>
            <button type="button" class="share" data-i="${i}" title="Share this survey">ðŸ”— Share</button>
          </div>
        `;
        qWrap.appendChild(q);
      });

      // attach share handlers and textarea input listeners
      document.querySelectorAll('.share').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const url = location.origin + location.pathname; // homepage link
          try {
            await navigator.clipboard.writeText(url);
            notify('Homepage link copied to clipboard');
          } catch(err){
            // fallback copy by prompt
            prompt('Copy this link', url);
          }
        });
      });

      document.querySelectorAll('textarea').forEach(el=>{
        el.addEventListener('input', validateForm);
      });

      validateForm();
    }

    function escapeHtml(s){
      return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    // form validation: ensure all textareas >=5 chars
    const submitBtn = document.getElementById('submitBtn');
    function validateForm(){
      const areas = Array.from(document.querySelectorAll('textarea'));
      const ok = areas.every(a => a.value.trim().length >= 5);
      submitBtn.disabled = !ok;
      return ok;
    }

    // on submit: store answers, increment balance by $0.5, clear inputs, then refresh questions (we'll reload to ensure consistency)
    const surveyForm = document.getElementById('surveyForm');
    surveyForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!validateForm()) { notify('Please answer all surveys (min 5 chars)', 2600); return; }
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      const user = auth.currentUser;
      if (!user) {
        notify('Not signed in. Redirecting to login...', 1800);
        setTimeout(()=> location.href = 'login.html', 1200);
        return;
      }
      const uid = user.uid;
      const email = user.email || '';
      // gather answers
      const answers = {};
      SURVEYS.forEach((_, i) => {
        answers['q'+(i+1)] = document.getElementById('q'+i).value.trim();
      });

      try{
        // push a submission record
        const submissionsRef = ref(db, `users/${uid}/submissions`);
        const newSubmissionRef = push(submissionsRef);
        await set(newSubmissionRef, {
          answers,
          timestamp: Date.now(),
          email: email
        });

        // increment balance atomically by 0.5
        const balRef = ref(db, `users/${uid}/balance`);
        await runTransaction(balRef, (current)=>{
          return (current || 0) + 0.5;
        });

        // update local displayed balance immediately
        const b = await get(child(ref(db), `users/${uid}/balance`));
        if (b.exists()) {
          updateBalanceDisplay(Number(b.val()));
        }

        // clear textareas
        document.querySelectorAll('textarea').forEach(t=> t.value = '');
        validateForm();

        notify('Submission successful â€” +$0.50 added to your balance', 2600);
        // refresh questions (spec says automatically refreshes) â€” we'll reload to ensure freshness
        setTimeout(()=> location.reload(), 1200);

      } catch(err){
        console.error(err);
        notify('Submission failed. Try again.', 2600);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit & Earn +$0.50';
      }
    });

    // update balance UI
    function updateBalanceDisplay(n){
      const el = document.getElementById('balanceVal');
      el.textContent = `$${Number(n).toFixed(2)}`;
    }

    // update user id UI (first 5 letters of email)
    function updateUserId(email){
      const idEl = document.getElementById('userId');
      const clean = (email || '').split('@')[0] || '';
      idEl.textContent = clean.slice(0,5) || 'guest';
    }

    // load user data from db: balance if exists, otherwise create default user node
    async function ensureUserNode(user){
      const uid = user.uid;
      const email = user.email || '';
      updateUserId(email);
      const userRef = ref(db, `users/${uid}`);
      try {
        const snap = await get(userRef);
        if (!snap.exists()) {
          // create minimal profile (do not store passwords)
          await set(userRef, { email, createdAt: Date.now(), balance: 0 });
          updateBalanceDisplay(0);
        } else {
          const data = snap.val();
          updateBalanceDisplay(Number(data.balance || 0));
        }
      } catch(e){
        console.error('read user', e);
        notify('Could not load profile',2000);
      }
    }

    // auth state handling
    onAuthStateChanged(auth, user=>{
      if (!user) {
        notify('Not signed in â€” redirecting',1600);
        setTimeout(()=> location.href = 'login.html',1100);
        return;
      }
      // user present: render questions and load profile
      renderQuestions();
      ensureUserNode(user);
    });

    // initial render (if not logged in yet, questions still render)
    renderQuestions();

    // small accessibility: allow Enter in menus etc
    document.getElementById('gotoHome').addEventListener('click', (e)=> { e.preventDefault(); notify('You are on Home'); });
    document.getElementById('gotoProfile').addEventListener('click', (e)=> { e.preventDefault(); notify('Profile coming soon'); });
    document.getElementById('gotoFAQ').addEventListener('click', (e)=> { e.preventDefault(); notify('FAQ coming soon'); });

  </script>
</body>
</html>
